name: Build and Push Docker Image to Prod

on:
  push:
    branches:
      - prod

env:
  REGION: us-west1
  IMAGE_NAME: us-west1-docker.pkg.dev/drunr-prod/drunr/prod-babblebeaver

jobs:
  build:
    name: Build and Push image to GCR
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout"
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # Step to install required build tools
    - name: Install required build tools
      run: |
        sudo apt-get update -y
        sudo apt-get install -y build-essential python3-dev gcc g++ make

    - id: "auth"
      uses: "google-github-actions/auth@v1"
      with:
        credentials_json: "${{ secrets.PROD_GCR_JSON_KEY }}"

    # Other steps remain the same
    - name: "Set up Cloud SDK"
      uses: "google-github-actions/setup-gcloud@v1"

    - name: "Use gcloud CLI"
      run: "gcloud info"

    - name: "Docker auth"
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    # Build docker image
    - name: Build docker image
      run: docker build -t $IMAGE_NAME:build-${{ github.run_number }} .

    # Push docker image to Artifact registry
    - name: Push to Google Artifact Registry
      run: docker push $IMAGE_NAME:build-${{ github.run_number }}

    - name: Update Kubernetes manifest in ops repo
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        TARGET_REPO: "DrunR-Software/ops"
        TARGET_FILE: "drunr-prod/babblebeaver/templates/manifest.yaml"
        TARGET_BRANCH: "main"
        IMAGE_TAG: "build-${{ github.run_number }}"
      run: |
        echo "üöÄ Updating Dev manifest to use $IMAGE_NAME:$IMAGE_TAG"

        # Clone the ops repository
        git clone https://x-access-token:$GITHUB_TOKEN@github.com/$TARGET_REPO.git ops-repo
        cd ops-repo
        git checkout $TARGET_BRANCH

        # Update only the main babblebeaver container image
        # This sed command finds the line with babblebeaver image and updates only that occurrence
        sed -i.bak "s|image: us-west1-docker.pkg.dev/drunr-prod/drunr/prod-babblebeaver:.*|image: $IMAGE_NAME:$IMAGE_TAG|" $TARGET_FILE

        # Verify the change was made
        if grep -q "$IMAGE_NAME:$IMAGE_TAG" $TARGET_FILE; then
          echo "‚úÖ Image tag updated successfully in manifest"
        else
          echo "‚ùå Failed to update image tag in manifest"
          exit 1
        fi

        # Configure git
        git config user.name "BabbleBeaver CI"
        git config user.email "ci-bot@drunr.com"

        # Commit and push changes
        git add $TARGET_FILE
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit - manifest already up to date"
        else
          git commit -m "üöÄ Deploy sensor-service:$IMAGE_TAG to Dev

        Automated deployment from sensor_service repository
        Source commit: ${{ github.sha }}
        Triggered by: ${{ github.actor }}
        Build number: ${{ github.run_number }}
        Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          git push origin $TARGET_BRANCH
          echo "‚úÖ Manifest updated and pushed successfully"
          echo "üîÑ Kubernetes pods will auto-refresh with new image"
        fi
